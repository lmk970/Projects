<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¢…ì´ì—†ëŠ” íšŒì˜ì‹¤ - í†µí•© QR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/static/kjua.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="box">
        <h2>ğŸ“ ë¬¸ì„œ ì—…ë¡œë“œ â†’ QR ìƒì„±</h2>
        <form id="uploadForm">
            <label class="file-label">
                ğŸ“‚ <span id="filename">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</span>
                <input type="file" id="fileInput" name="file" required>
            </label>
            <button type="submit" class="btn">ğŸ“¤ ì—…ë¡œë“œ</button>
            <button class="btn danger" id="resetBtn">ğŸ“œ ì´ë ¥ ì´ˆê¸°í™”</button>
        </form>

        <div id="info"></div>
        <div id="qrcode"></div>

        <div id="buttons" style="display:none;">
            <button class="btn" id="openBtn">ğŸ”“ ë¬¸ì„œ ì—´ê¸°</button>
            <button class="btn" id="copyBtn">ğŸ“‹ ë§í¬ ë³µì‚¬</button>
            <button class="btn" id="saveQRBtn">â¬‡ï¸ QR ì €ì¥</button>
        </div>

        <div id="error" style="color: red; margin-top:10px;"></div>

        <footer class="footer">
            Â© All rights reserved.<br>
            Powered by Hancom Document Viewer API<br>
            For internal use only.<br>
            ì´ìš©ë¬¸ì˜ : ì¶©ì²­ë‚¨ë„ ì •ë³´í™”ë‹´ë‹¹ê´€ (â˜3719)
        </footer>
    </div>

    <script>
        let docUrl = "";
        const fileInput = document.getElementById("fileInput");
        const filenameLabel = document.getElementById("filename");

        fileInput.addEventListener("change", () => {
            filenameLabel.textContent = fileInput.files[0]?.name || "íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”";
        });

        document.getElementById("uploadForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            document.getElementById("info").textContent = "";
            document.getElementById("error").textContent = "";
            document.getElementById("qrcode").innerHTML = "";
            document.getElementById("buttons").style.display = "none";

            const file = fileInput.files[0];
            if (!file) {
                document.getElementById("error").textContent = "íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.";
                return;
            }

            const formData = new FormData();
            formData.append("file", file);

            try {
                const res = await fetch("/upload", { method: "POST", body: formData });
                if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");

                const data = await res.json();
                docUrl = location.origin + data.short_url;

                document.getElementById("info").innerHTML = `ğŸ” ë¹„ë°€ë²ˆí˜¸: <strong>${data.password}</strong>`;

                const qr = kjua({ render: "canvas", size: 220, text: docUrl });
                qr.id = "qr-canvas";
                document.getElementById("qrcode").appendChild(qr);
                document.getElementById("buttons").style.display = "block";
            } catch (err) {
                document.getElementById("error").textContent = "ì—…ë¡œë“œ ì‹¤íŒ¨: " + err.message;
            }
        });

        document.getElementById("openBtn").addEventListener("click", () => {
            if (docUrl) window.open(docUrl, "_blank");
        });

        document.getElementById("copyBtn").addEventListener("click", () => {
            if (!docUrl) return;

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(docUrl)
                    .then(() => alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"))
                    .catch(() => fallbackCopy(docUrl));
            } else {
                fallbackCopy(docUrl);
            }
        });

        function fallbackCopy(text) {
            const input = document.createElement("input");
            input.value = text;
            document.body.appendChild(input);
            input.select();
            document.execCommand("copy");
            document.body.removeChild(input);
            alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        document.getElementById("saveQRBtn").addEventListener("click", () => {
            const canvas = document.getElementById("qr-canvas");
            if (canvas) {
                const link = document.createElement("a");
                link.download = "qr.png";
                link.href = canvas.toDataURL("image/png");
                link.click();
            }
        });

        document.getElementById("resetBtn").addEventListener("click", async () => {
            const confirmReset = confirm("ì •ë§ ëª¨ë“  ìƒì„± ì´ë ¥ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (!confirmReset) return;

            const input = prompt("ì´ˆê¸°í™”ë¥¼ ìœ„í•œ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (!/^\d+$/.test(input)) {
                alert("ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }
            if (input !== "1234") {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            try {
                const res = await fetch("/reset", { method: "POST" });
                const result = await res.json();
                if (result.success) {
                    alert("ë§í¬ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload();
                }
            } catch {
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });
    </script>
</body>
</html>
