<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¢…ì´ì—†ëŠ” íšŒì˜ì‹¤ - í†µí•© QR</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h2>ğŸ“„ ë¬¸ì„œ ì—…ë¡œë“œ â†’ ì—´ëŒ + QR ìƒì„±</h2>
    <form id="uploadForm">
      <label for="fileInput">ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”:</label>
      <input type="file" id="fileInput" required />
      <button type="submit">ğŸš€ ì—…ë¡œë“œ ë° ë³€í™˜</button>
    </form>
    <div id="result"></div>
    <div id="qrcode"></div>
    <div id="error"></div>
  </div>

  <script src="./kjua.min.js"></script>
  <script type="module">
    import { shortenUrl } from './api.js';

    const extToApiMap = {
      hwp: "hwp", hwpx: "hwp", doc: "word", docx: "word",
      ppt: "ppt", pptx: "ppt", xls: "cell", xlsx: "cell",
      txt: "txt", pdf: null
    };

    function generatePassword() {
      return Math.floor(1000 + Math.random() * 9000).toString();
    }

    async function hashSHA256(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return [...new Uint8Array(hashBuffer)].map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function addQrDownloadButton(qrDiv) {
      const canvas = qrDiv.querySelector("canvas");
      if (!canvas) return;
      const btn = document.createElement("button");
      btn.id = "downloadBtn";
      btn.textContent = "QRì½”ë“œ ë‹¤ìš´ë¡œë“œ";
      btn.onclick = () => {
        const a = document.createElement("a");
        a.download = "qr.png";
        a.href = canvas.toDataURL("image/png");
        a.click();
      };
      qrDiv.appendChild(btn);
    }

    function addCopyButton(qrDiv, url) {
      const btn = document.createElement("button");
      btn.id = "copyBtn";
      btn.textContent = "ë§í¬ ë³µì‚¬";
      btn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(url);
          alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch {
          alert("ë³µì‚¬ ì‹¤íŒ¨. ìˆ˜ë™ ë³µì‚¬ ë°”ëë‹ˆë‹¤.");
        }
      };
      qrDiv.appendChild(btn);
    }

    function renderResult(url, resultDiv, qrDiv, password) {
      resultDiv.innerHTML = `
        âœ… ë¬¸ì„œ ë§í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤:<br />
        <button id="openBtn">ë¬¸ì„œ ì—´ê¸°</button>
        <div class="info">${url}</div>
        <div class="info"><strong>ë¹„ë°€ë²ˆí˜¸: ${password}</strong></div>
      `;
      document.getElementById("openBtn").onclick = () => {
        window.open(url, "_blank");
      };
      const qr = kjua({ render: 'canvas', text: url, size: 160 });
      qrDiv.innerHTML = "";
      qrDiv.appendChild(qr);
      addQrDownloadButton(qrDiv);
      addCopyButton(qrDiv, url);
    }

    async function handleUpload(file, resultDiv, qrDiv, errorDiv) {
      try {
        const ext = file.name.split('.').pop().toLowerCase();
        const formData = new FormData();
        formData.append("file", file);

        const uploadRes = await fetch("http://210.95.181.17:8101/rest/upload_file", {
          method: "POST", body: formData
        });
        const uploadJson = await uploadRes.json();
        const filePath = uploadJson.upload_file_path;
        if (!filePath) throw new Error("ì—…ë¡œë“œ ì‹¤íŒ¨");

        let finalUrl = "";
        if (ext === "pdf") {
          finalUrl = `http://210.95.181.17:8101/hdv/view/?file_path=${filePath}&ext_to=pdf`;
        } else {
          const api = extToApiMap[ext];
          if (!api) throw new Error("ì§€ì›í•˜ì§€ ì•ŠëŠ” í™•ì¥ì");
          const convert = await fetch(`http://210.95.181.17:8101/${api}/doc2pdf?file_path=${filePath}&show_type=2&function=sync`);
          const json = await convert.json();
          const pdfPath = json.docsconverter?.file?.target_file;
          if (!pdfPath) throw new Error("PDF ë³€í™˜ ì‹¤íŒ¨");
          finalUrl = `http://210.95.181.17:8101/hdv/view/?file_path=${pdfPath}&ext_to=pdf`;
        }

        const shortUrl = await shortenUrl(finalUrl);
        const password = generatePassword();
        const fullHash = await hashSHA256(password);
        const hash10 = fullHash.slice(0, 10);
        const protectedUrl = `${location.origin}/passcheck.html?url=${encodeURIComponent(shortUrl)}&hash=${hash10}`;
        renderResult(protectedUrl, resultDiv, qrDiv, password);
      } catch (err) {
        console.error(err);
        errorDiv.textContent = "âŒ ì˜¤ë¥˜: " + err.message;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("uploadForm");
      const resultDiv = document.getElementById("result");
      const errorDiv = document.getElementById("error");
      const qrDiv = document.getElementById("qrcode");

      form.addEventListener("submit", async e => {
        e.preventDefault();
        resultDiv.innerHTML = "";
        errorDiv.textContent = "";
        qrDiv.innerHTML = "";
        const file = document.getElementById("fileInput").files[0];
        if (!file) {
          errorDiv.textContent = "âš ï¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
          return;
        }
        await handleUpload(file, resultDiv, qrDiv, errorDiv);
      });
    });
  </script>
</body>
</html>
